<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphic Organizers - Readings in Philippine History</title>
    <link rel="icon" href="Images/favicon.png" type="image/png">
    <link rel="stylesheet" href="Styles/course.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="JS/supabase-config.js"></script>
    <script src="JS/db-helpers.js"></script>
    <script src="JS/course.js"></script>
    <style>
        main.main-content {
            padding: 40px 32px;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
        }

        .page-title {
            margin-bottom: 40px;
        }

        .page-title h1 {
            font-size: 48px;
            font-weight: 800;
            color: #51513E;
            margin: 0 0 8px 0;
            letter-spacing: -1px;
        }

        .page-title p {
            font-size: 18px;
            color: #7A5B47;
            margin: 0;
            font-weight: 400;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }

        .stat-card {
            background: linear-gradient(135deg, #D6DCE1, #ffffff);
            border: 1px solid #D6DCE1;
            border-radius: 12px;
            padding: 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #D6DCE1;
            box-shadow: 0 8px 24px rgba(68, 41, 19, 0.08);
            transform: translateY(-2px);
        }

        .stat-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon-box {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-card:nth-child(1) .stat-icon-box {
            background: rgba(59, 130, 246, 0.12);
        }

        .stat-card:nth-child(2) .stat-icon-box {
            background: rgba(34, 197, 94, 0.12);
        }

        .stat-card:nth-child(3) .stat-icon-box {
            background: rgba(139, 92, 246, 0.12);
        }

        .organizers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 26px;
            margin-bottom: 40px;
        }

        .organizer-card {
            background: white;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .organizer-card:hover {
            border-color: #d0d0d0;
            box-shadow: 0 12px 40px rgba(68, 41, 19, 0.12);
            transform: translateY(-8px);
        }

        .organizer-top {
            padding: 24px;
            border-bottom: 1px solid #f5f5f5;
        }

        .organizer-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 5px 11px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .badge-topic {
            background: rgba(59, 130, 246, 0.15);
            color: #1e40af;
        }

        .badge-type {
            background: rgba(34, 197, 94, 0.15);
            color: #047857;
        }

        .organizer-title {
            font-size: 18px;
            font-weight: 700;
            color: #51513E;
            margin: 0 0 8px 0;
            line-height: 1.4;
        }

        .organizer-description {
            font-size: 14px;
            color: #7A5B47;
            margin: 0 0 16px 0;
            line-height: 1.5;
        }

        .organizer-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: #9CA3AF;
        }

        .organizer-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .organizer-actions {
            padding: 20px 24px;
            background: #FAFAFA;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 12px;
        }

        .organizer-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }

        .organizer-btn.primary {
            background: #5C3422;
            color: white;
        }

        .organizer-btn.primary:hover {
            background: #442913;
        }

        .organizer-btn.secondary {
            background: white;
            color: #5C3422;
            border: 1px solid #D4BBAC;
        }

        .organizer-btn.secondary:hover {
            background: #F9F6F4;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .controls-left h2 {
            font-size: 24px;
            font-weight: 700;
            color: #51513E;
            margin: 0;
        }

        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #E2D5C2;
            background: white;
            color: #7A5B47;
        }

        .filter-chip:hover {
            background: #F9F6F4;
            border-color: #D4BBAC;
        }

        .filter-chip.active {
            background: #5C3422;
            color: white;
            border-color: #5C3422;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filters {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="header">
        <div class="header-container">
            <button id="toggleSidebar" style="background: none; border: none; color: #5C3422; cursor: pointer; font-size: 24px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; z-index: 1001;">
                â˜°
            </button>

            <div class="header-logo">
                <img src="Images/favicon.png" alt="RPH Logo" class="header-logo-img">
                <h1 class="header-title"><a href="home.html" class="header-title-link">RPH Interactive Learning Hub
</a></h1>
            </div>

            <div class="header-actions">
                <div class="header-search">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search users..." />
                    <button class="search-btn" id="searchBtn" title="Search">
                        <i data-lucide="search" style="width: 18px; height: 18px;"></i>
                    </button>
                </div>
                
                <button class="sidebar-toggle-right" id="sidebarToggleRight" title="Show more">
                    <i data-lucide="layout-grid" style="width: 20px; height: 20px;"></i>
                </button>
                <button class="logout-btn" title="Logout">
                    <i data-lucide="log-out" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <!-- Left Sidebar Navigation -->
        <aside class="left-sidebar mobile-sidebar" id="leftSidebar">
            <!-- User Profile Section -->
            <div class="user-profile">
                <img src=https://i.pravatar.cc/80?img=20 alt="User avatar" class="profile-avatar" id="profileAvatar" />
                <div class="profile-info">
                    <h4 class="profile-name" id="profileName">Loading...</h4>
                    <p class="profile-email" id="profileEmail">Loading...</p>
                </div>
                <button class="edit-profile-btn" id="editProfileBtn" title="Edit profile">
                    <i data-lucide="edit-2" style="width: 16px; height: 16px;"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="course.html" class="nav-item" data-section="feed">
                    <i data-lucide="radio" class="nav-icon-svg"></i>
                    <span>Feed</span>
                </a>
                <div class="nav-item-dropdown">
                    <div class="nav-item" data-section="topic">
                        <i data-lucide="book-open" class="nav-icon-svg"></i>
                        <span>Topic</span>
                        <i data-lucide="chevron-down" class="dropdown-arrow"></i>
                    </div>
                    <div class="dropdown-menu">
                        <a href="first-mass.html" class="dropdown-item">First Mass</a>
                        <a href="cavite-mutiny.html" class="dropdown-item">Cavite Mutiny</a>
                        <a href="retraction-of-rizal.html" class="dropdown-item">Retraction of Rizal</a>
                        <a href="cry-of-rebellion.html" class="dropdown-item">Cry of Rebellion</a>
                    </div>
                </div>
                <div class="nav-item-dropdown open">
                    <div class="nav-item" data-section="activities">
                        <i data-lucide="calendar" class="nav-icon-svg"></i>
                        <span>Learning Hub</span>
                        <i data-lucide="chevron-down" class="dropdown-arrow"></i>
                    </div>
                    <div class="dropdown-menu">
                        <a href="games.html" class="dropdown-item" data-section="games">
                            <i data-lucide="gamepad-2" style="width: 16px; height: 16px;"></i>
                            Games
                        </a>

                        <a href="interactive-tasks.html" class="dropdown-item" data-section="interactive">
                            <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                            Interactive Tasks
                        </a>

                        <a href="worksheets.html" class="dropdown-item" data-section="worksheets">
                            <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                            Worksheets
                        </a>
                    </div>
                </div>


                <a href="videos.html" class="nav-item" data-section="videos">
                    <i data-lucide="play-circle" class="nav-icon-svg"></i>
                    <span>Videos</span>
                </a>
            </nav>

        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-title">
                <h1>Graphic Organizers</h1>
                <p>Visual tools to organize and connect historical concepts</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon-box">
                            <i data-lucide="layout" style="width: 24px; height: 24px; color: #3b82f6;"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Available Organizers</h3>
                            <p class="number" id="totalOrganizers">0</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon-box">
                            <i data-lucide="download" style="width: 24px; height: 24px; color: #10b981;"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Downloaded</h3>
                            <p class="number" id="downloadedOrganizers">0</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon-box">
                            <i data-lucide="edit" style="width: 24px; height: 24px; color: #8b5cf6;"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Completed</h3>
                            <p class="number" id="completedOrganizers">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <div class="controls-left">
                    <h2>Available Graphic Organizers</h2>
                </div>
                <div class="filters">
                    <button class="filter-chip active" data-filter="all">All</button>
                    <button class="filter-chip" data-filter="cavite">Cavite Mutiny</button>
                    <button class="filter-chip" data-filter="rizal">Rizal's Retraction</button>
                    <button class="filter-chip" data-filter="rebellion">Cry of Rebellion</button>
                    <button class="filter-chip" data-filter="mass">First Mass</button>
                </div>
            </div>

            <div class="organizers-grid" id="organizersGrid">
                <!-- Graphic organizers will be loaded here -->
            </div>
        </main>
    </div>

    <script>
        // Redirect to worksheets.html with organizers tab
        window.location.href = 'worksheets.html?tab=organizers';
    </script>
    <script>
        // Graphic organizers data
        const organizers = [
            {
                id: 1,
                title: "Cavite Mutiny Timeline Organizer",
                description: "Visual timeline organizer to map out key events, causes, and consequences of the Cavite Mutiny.",
                topic: "cavite",
                type: "Timeline",
                difficulty: "Intermediate",
                pages: 1,
                estimatedTime: "30 min"
            },
            {
                id: 2,
                title: "Rizal's Retraction Mind Map",
                description: "Mind mapping organizer to explore the controversy surrounding Jose Rizal's retraction and its implications.",
                topic: "rizal",
                type: "Mind Map",
                difficulty: "Advanced",
                pages: 1,
                estimatedTime: "45 min"
            },
            {
                id: 3,
                title: "Cry of Rebellion Cause-Effect Chain",
                description: "Cause and effect organizer to analyze the chain of events leading to the Cry of Rebellion.",
                topic: "rebellion",
                type: "Cause-Effect",
                difficulty: "Intermediate",
                pages: 1,
                estimatedTime: "35 min"
            },
            {
                id: 4,
                title: "First Mass Venn Diagram",
                description: "Compare and contrast different historical accounts of the First Mass in the Philippines.",
                topic: "mass",
                type: "Venn Diagram",
                difficulty: "Beginner",
                pages: 1,
                estimatedTime: "25 min"
            },
            {
                id: 5,
                title: "Philippine Revolution Flow Chart",
                description: "Flow chart organizer showing the progression of events during the Philippine Revolution.",
                topic: "rebellion",
                type: "Flow Chart",
                difficulty: "Advanced",
                pages: 2,
                estimatedTime: "50 min"
            },
            {
                id: 6,
                title: "Key Figures Comparison Matrix",
                description: "Matrix organizer to compare important historical figures and their roles in Philippine history.",
                topic: "all",
                type: "Comparison Matrix",
                difficulty: "Intermediate",
                pages: 1,
                estimatedTime: "40 min"
            }
        ];

        // Initialize organizers page
        document.addEventListener('DOMContentLoaded', function() {
            loadOrganizers();
            setupFilters();
            updateStats();
            initializeLucideIcons();
            setupSidebarToggle();
        });

        function initializeLucideIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function setupSidebarToggle() {
            // ==================== LEFT SIDEBAR TOGGLE ====================
            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('leftSidebar');

            console.log('toggleBtn:', toggleBtn);
            console.log('sidebar:', sidebar);

            if (toggleBtn && sidebar) {
                toggleBtn.addEventListener('click', function() {
                    console.log('Button clicked!');
                    console.log('Before toggle:', sidebar.className);
                    sidebar.classList.toggle('mobile-open');
                    console.log('After toggle:', sidebar.className);
                    console.log('Computed display:', window.getComputedStyle(sidebar).display);
                });
            }

            // Initialize course interface for authentication and logout
            const courseInterface = new CourseInterface();
            courseInterface.init();

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');

            function performSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                const grid = document.getElementById('organizersGrid');
                const organizerCards = grid.querySelectorAll('.organizer-card');

                if (!searchTerm) {
                    // Show all organizers if search is empty
                    organizerCards.forEach(card => {
                        card.style.display = 'block';
                    });
                    return;
                }

                organizerCards.forEach(card => {
                    const title = card.querySelector('.organizer-title').textContent.toLowerCase();
                    const description = card.querySelector('.organizer-description').textContent.toLowerCase();
                    const topic = card.dataset.topic ? card.dataset.topic.toLowerCase() : '';

                    if (title.includes(searchTerm) || description.includes(searchTerm) || topic.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('input', performSearch); // Search as you type
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });

            // Edit profile functionality
            const editProfileBtn = document.getElementById('editProfileBtn');
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', function() {
                    alert('Profile editing functionality would be implemented here.');
                });
            }
        }

        function loadOrganizers(filter = 'all') {
            const grid = document.getElementById('organizersGrid');
            grid.innerHTML = '';

            const filteredOrganizers = filter === 'all'
                ? organizers
                : organizers.filter(o => o.topic === filter);

            filteredOrganizers.forEach(organizer => {
                const organizerCard = createOrganizerCard(organizer);
                grid.appendChild(organizerCard);
            });

            // Re-initialize icons after adding cards
            setTimeout(initializeLucideIcons, 100);
        }

        function createOrganizerCard(organizer) {
            const card = document.createElement('div');
            card.className = 'organizer-card';
            card.setAttribute('data-topic', organizer.topic);
            card.innerHTML = `
                <div class="organizer-top">
                    <div class="organizer-badges">
                        <span class="badge badge-topic">${getTopicName(organizer.topic)}</span>
                        <span class="badge badge-type">${organizer.type}</span>
                    </div>
                    <h3 class="organizer-title">${organizer.title}</h3>
                    <p class="organizer-description">${organizer.description}</p>
                    <div class="organizer-meta">
                        <div class="organizer-meta-item">
                            <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                            ${organizer.pages} page${organizer.pages > 1 ? 's' : ''}
                        </div>
                        <div class="organizer-meta-item">
                            <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                            ${organizer.estimatedTime}
                        </div>
                    </div>
                </div>
                <div class="organizer-actions">
                    <button class="organizer-btn secondary" onclick="previewOrganizer(${organizer.id})">
                        <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                        Preview
                    </button>
                    <button class="organizer-btn primary" onclick="downloadOrganizer(${organizer.id})">
                        <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                        Download
                    </button>
                </div>
            `;
            return card;
        }

        function getTopicName(topic) {
            const names = {
                cavite: 'Cavite Mutiny',
                rizal: "Rizal's Retraction",
                rebellion: 'Cry of Rebellion',
                mass: 'First Mass',
                all: 'General'
            };
            return names[topic] || topic;
        }

        function setupFilters() {
            const filterChips = document.querySelectorAll('.filter-chip');
            filterChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    filterChips.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    loadOrganizers(this.dataset.filter);
                });
            });
        }

        function updateStats() {
            document.getElementById('totalOrganizers').textContent = organizers.length;
            // In a real app, these would come from user data
            document.getElementById('downloadedOrganizers').textContent = '0';
            document.getElementById('completedOrganizers').textContent = '0';
        }

        function previewOrganizer(id) {
            const organizer = organizers.find(o => o.id === id);
            alert(`Preview: ${organizer.title}\n\nThis would open a PDF preview in a real implementation.`);
        }

        function downloadOrganizer(id) {
            const organizer = organizers.find(o => o.id === id);
            alert(`Downloading: ${organizer.title}\n\nThis would trigger a PDF download in a real implementation.`);
        }

        // ==================== PROFILE EDITING SYSTEM ====================
        const editProfileBtn = document.getElementById('editProfileBtn');
        const editProfileModal = document.getElementById('editProfileModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const editAvatarInput = document.getElementById('editAvatar');
        const avatarPreview = document.getElementById('avatarPreview');
        const editNameInput = document.getElementById('editName');
        const editBioInput = document.getElementById('editBio');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        const profileNameDisplay = document.querySelector('.profile-name');
        const profileEmailDisplay = document.querySelector('.profile-email');
        const profileAvatar = document.querySelector('.profile-avatar');

        // ==================== LOAD PROFILE FROM DATABASE ====================
        // Helper function to get Supabase client
        async function getSupabaseClient() {
            let attempts = 0;
            while (attempts < 50) {
                if (window.supabaseClient) {
                    return window.supabaseClient;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            throw new Error('Supabase client not initialized. Please refresh the page.');
        }

        async function loadProfileFromDatabase() {
            try {
                console.log('ðŸ“š Fetching profile from database...');
                const supabaseClient = await getSupabaseClient();
                const { data: session, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError || !session?.session?.user) {
                    console.log('â„¹ï¸ No active session, loading from localStorage');
                    loadProfileFromStorage();
                    return;
                }
                
                const currentEmail = session.session.user.email;
                const userId = session.session.user.id;
                
                console.log('ðŸ“š Fetching profile from database for user:', userId);
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId);
                
                if (error) {
                    console.warn('âš ï¸ Could not fetch from database:', error.message);
                    loadProfileFromStorage();
                    return;
                }
                
                if (data && data.length > 0) {
                    const profile = data[0];
                    console.log('ðŸ“¦ Loaded from database - Name:', profile.full_name, 'Bio:', profile.bio, 'Avatar:', profile.avatar_url ? 'Yes' : 'No');
                    
                    if (profile.full_name) {
                        console.log('âœ… Setting name to:', profile.full_name);
                        profileNameDisplay.textContent = profile.full_name;
                        localStorage.setItem('profileName', profile.full_name);
                    }
                    if (profile.bio) {
                        console.log('âœ… Setting bio to:', profile.bio);
                        profileEmailDisplay.textContent = profile.bio;
                        localStorage.setItem('profileBio', profile.bio);
                    }
                    if (profile.avatar_url) {
                        console.log('âœ… Setting avatar');
                        profileAvatar.src = profile.avatar_url;
                        localStorage.setItem('profileAvatar', profile.avatar_url);
                    }
                    
                    // Store current user email for post filtering
                    localStorage.setItem('currentUserId', currentEmail);
                } else {
                    console.log('â„¹ï¸ No profile in database, loading from localStorage');
                    loadProfileFromStorage();
                }
            } catch (err) {
                console.warn('âš ï¸ Error loading from database:', err.message);
                loadProfileFromStorage();
            }
        }

        // ==================== LOAD PROFILE FROM localStorage ====================
        function loadProfileFromStorage() {
            console.log('ðŸ” Loading profile from localStorage...');
            const savedName = localStorage.getItem('profileName');
            const savedBio = localStorage.getItem('profileBio');
            const savedAvatar = localStorage.getItem('profileAvatar');

            if (savedName && profileNameDisplay) profileNameDisplay.textContent = savedName;
            if (savedBio && profileEmailDisplay) profileEmailDisplay.textContent = savedBio;
            if (savedAvatar && profileAvatar) profileAvatar.src = savedAvatar;
        }

        // ==================== EDIT PROFILE MODAL MANAGEMENT ====================
        if (editProfileBtn) {
            editProfileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                editProfileModal.style.display = 'flex';
                editNameInput.value = localStorage.getItem('profileName') || '';
                editBioInput.value = localStorage.getItem('profileBio') || '';
                const savedAvatar = localStorage.getItem('profileAvatar');
                if (savedAvatar) avatarPreview.src = savedAvatar;
            });
        }

        if (closeEditModal) {
            closeEditModal.addEventListener('click', function() {
                editProfileModal.style.display = 'none';
            });
        }

        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', function() {
                editProfileModal.style.display = 'none';
            });
        }

        editProfileModal.addEventListener('click', function(e) {
            if (e.target === editProfileModal) {
                editProfileModal.style.display = 'none';
            }
        });

        // ==================== AVATAR FILE UPLOAD ====================
        if (editAvatarInput) {
            editAvatarInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64String = event.target.result;
                        avatarPreview.src = base64String;
                        console.log('ðŸ“ Avatar preview updated');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // ==================== SAVE PROFILE CHANGES ====================
        if (saveProfileBtn) {
            saveProfileBtn.addEventListener('click', function() {
                alert('To change your profile, please navigate to the Feed page (course.html). Click on your profile picture in the sidebar to edit your profile there.');
                editProfileModal.style.display = 'none';
            });
        }

        // ==================== MUTATIONOBSERVER: RESTORE PROFILE ON CHANGES ====================
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.target === profileNameDisplay && profileNameDisplay.textContent !== localStorage.getItem('profileName')) {
                    console.log('ðŸ” Profile Name changed by Supabase, restoring from localStorage...');
                    profileNameDisplay.textContent = localStorage.getItem('profileName') || profileNameDisplay.textContent;
                }
                if (mutation.target === profileEmailDisplay && profileEmailDisplay.textContent !== localStorage.getItem('profileBio')) {
                    console.log('ðŸ” Profile Bio changed by Supabase, restoring from localStorage...');
                    profileEmailDisplay.textContent = localStorage.getItem('profileBio') || profileEmailDisplay.textContent;
                }
                if (mutation.target === profileAvatar && profileAvatar.src !== localStorage.getItem('profileAvatar')) {
                    console.log('ðŸ” Profile Avatar changed by Supabase, restoring from localStorage...');
                    profileAvatar.src = localStorage.getItem('profileAvatar') || profileAvatar.src;
                }
            });
        });

        observer.observe(profileNameDisplay, { attributes: true, childList: true, subtree: true });
        observer.observe(profileEmailDisplay, { attributes: true, childList: true, subtree: true });
        observer.observe(profileAvatar, { attributes: true, childList: true, subtree: true });

        // ==================== PERIODIC RESTORATION: Every 1000ms ====================
        setInterval(function() {
            const currentName = profileNameDisplay ? profileNameDisplay.textContent : '';
            const savedName = localStorage.getItem('profileName');
            if (currentName !== savedName && savedName) {
                console.log('ðŸ”„ Periodic: Restoring profile name from localStorage');
                if (profileNameDisplay) profileNameDisplay.textContent = savedName;
            }

            const currentBio = profileEmailDisplay ? profileEmailDisplay.textContent : '';
            const savedBio = localStorage.getItem('profileBio');
            if (currentBio !== savedBio && savedBio) {
                console.log('ðŸ”„ Periodic: Restoring profile bio from localStorage');
                if (profileEmailDisplay) profileEmailDisplay.textContent = savedBio;
            }

            const currentAvatar = profileAvatar ? profileAvatar.src : '';
            const savedAvatar = localStorage.getItem('profileAvatar');
            if (currentAvatar !== savedAvatar && savedAvatar) {
                console.log('ðŸ”„ Periodic: Restoring profile avatar from localStorage');
                if (profileAvatar) profileAvatar.src = savedAvatar;
            }
        }, 1000);

        // ==================== OVERRIDE: SUPABASE populateUserProfile ====================
        const checkForApp = setInterval(function() {
            if (window.app && window.app.populateUserProfile) {
                clearInterval(checkForApp);
                const originalPopulate = window.app.populateUserProfile.bind(window.app);
                window.app.populateUserProfile = function() {
                    console.log('ðŸ”´ populateUserProfile called by Supabase');
                    originalPopulate();
                    setTimeout(function() {
                        loadProfileFromDatabase();
                        console.log('ðŸŸ¢ Profile restored from database after Supabase call');
                    }, 500);
                };
            }
        }, 100);

        // ==================== STORAGE EVENT LISTENER: Cross-tab Synchronization ====================
        window.addEventListener('storage', function(e) {
            if (e.key === 'profileName' || e.key === 'profileBio' || e.key === 'profileAvatar') {
                console.log('ðŸ’¾ Storage changed in another tab, reloading profile...');
                loadProfileFromDatabase();
            }
        });

        // ==================== INITIALIZE PROFILE LOADING ====================
        // Load profile on page load
        loadProfileFromDatabase();

        // ==================== LOGOUT BUTTON ====================
        const logoutBtn = document.querySelector('.logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    // Clear all local storage
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Sign out from Supabase globally
                    const supabaseClient = await getSupabaseClient();
                    const { error } = await supabaseClient.auth.signOut({ scope: 'global' });
                    if (error) {
                        console.error('Supabase signOut error:', error);
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                } finally {
                    // Force redirect to index after clearing everything
                    window.location.href = 'index.html';
                }
            });
        }

        // ==================== LEFT SIDEBAR TOGGLE ====================
        const toggleBtn = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('leftSidebar');
        
        console.log('toggleBtn:', toggleBtn);
        console.log('sidebar:', sidebar);
        
        if (toggleBtn && sidebar) {
            toggleBtn.addEventListener('click', function() {
                console.log('Button clicked!');
                console.log('Before toggle:', sidebar.className);
                sidebar.classList.toggle('mobile-open');
                console.log('After toggle:', sidebar.className);
                console.log('Computed display:', window.getComputedStyle(sidebar).display);
            });
        }
    </script>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="modal-close" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Profile Picture</label>
                    <img id="avatarPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23e0e0e0' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' font-size='24' fill='%23999' text-anchor='middle' dy='.3em'%3EðŸ‘¤%3C/text%3E%3C/svg%3E" alt="Profile preview" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 12px;" />
                    <p style="margin: 0; color: #666; font-size: 14px; background: #f0f0f0; padding: 12px; border-radius: 6px; border-left: 4px solid #5C3422;">
                        ðŸ’¡ <strong>To change your profile picture,</strong> go to the <a href="course.html" style="color: #5C3422; text-decoration: underline;">Feed page</a>
                    </p>
                </div>
                <div class="form-group">
                    <label for="editName">Full Name</label>
                    <input type="text" id="editName" placeholder="Your name" />
                </div>
                <div class="form-group">
                    <label for="editBio">Bio</label>
                    <textarea id="editBio" placeholder="Tell us about yourself" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="cancelEditBtn">Cancel</button>
                <button class="btn-save" id="saveProfileBtn">Save Changes</button>
            </div>
        </div>
    </div>
</body>
</html>
