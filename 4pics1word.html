<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Pics 1 Word - Readings in Philippine History</title>
    <link rel="icon" href="Images/favicon.png" type="image/png">
    <link rel="stylesheet" href="Styles/course.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="JS/supabase-config.js"></script>
    <script src="JS/db-helpers.js"></script>
    <style>
        .game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .game-card-main {
            background: white;
            border-radius: 20px;
            padding: 50px 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(68, 41, 19, 0.15);
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .game-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .game-header h1 {
            font-size: 42px;
            font-weight: 800;
            color: #51513E;
            margin: 0 0 8px 0;
        }

        .game-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 16px;
        }

        .game-stat {
            text-align: center;
        }

        .game-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #8B7355;
        }

        .game-stat-label {
            font-size: 12px;
            color: #7A5B47;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .pictures-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .picture-item {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #f5f3f0 0%, #ede9e4 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            border: 3px solid #e8e3dd;
            animation: popIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .picture-item:hover {
            transform: scale(1.05);
        }

        /* Image Modal Styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        .image-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-image-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 80vw;
            max-height: 80vh;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        .modal-image-content img {
            width: 100%;
            height: auto;
            max-height: 70vh;
            border-radius: 8px;
            display: block;
        }

        .modal-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            font-size: 28px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #51513E;
            margin-bottom: 12px;
            text-align: center;
        }

        .game-input {
            width: 100%;
            padding: 16px 20px;
            border: 3px solid #d8cfc8;
            border-radius: 12px;
            font-size: 18px;
            font-family: inherit;
            text-align: center;
            transition: all 0.3s ease;
            color: #51513E;
            font-weight: 600;
        }

        .game-input:focus {
            outline: none;
            border-color: #8B7355;
            background: linear-gradient(135deg, #faf8f6 0%, #f5f3f0 100%);
            box-shadow: 0 0 0 4px rgba(139, 115, 85, 0.1);
        }

        .game-input::placeholder {
            color: #a89b8f;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .game-btn {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .game-btn-submit {
            background: linear-gradient(135deg, #8B7355 0%, #6B5344 100%);
            color: white;
        }

        .game-btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 115, 85, 0.3);
        }

        .game-btn-submit:active {
            transform: translateY(-1px);
        }

        .game-btn-skip {
            background: #f0f0f0;
            color: #51513E;
            border: 2px solid #d0d0d0;
            font-weight: 600;
        }

        .game-btn-skip:hover {
            background: #e8e8e8;
            border-color: #b0b0b0;
        }

        .feedback-message {
            padding: 16px 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: 700;
            display: none;
            margin-bottom: 20px;
            font-size: 16px;
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feedback-message.show {
            display: block;
        }

        .feedback-message.correct {
            background: #e8f5e9;
            color: #2e7d32;
            border: 3px solid #81c784;
        }

        .feedback-message.incorrect {
            background: #ffebee;
            color: #c62828;
            border: 3px solid #ef5350;
        }

        .back-button {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #f0f0f0;
            color: #51513E;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .back-button:hover {
            background: #e0e0e0;
            transform: translateX(-4px);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e8e3dd;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B7355 0%, #a89b8f 100%);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .game-card-main {
                padding: 30px 20px;
            }

            .game-header h1 {
                font-size: 32px;
            }

            .game-stats {
                gap: 20px;
            }

            .game-stat-value {
                font-size: 24px;
            }

            .pictures-grid {
                gap: 12px;
                margin-bottom: 30px;
            }

            .picture-item {
                font-size: 56px;
            }

            .game-btn {
                padding: 14px 16px;
                font-size: 14px;
            }

            .game-container {
                padding: 20px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="header">
        <div class="header-container">
            <button id="toggleSidebar" style="background: none; border: none; color: #5C3422; cursor: pointer; font-size: 24px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; z-index: 10001; position: relative; pointer-events: auto;">
                ‚ò∞
            </button>

            <div class="header-logo">
                <img src="Images/favicon.png" alt="RPH Logo" class="header-logo-img">
                <h1 class="header-title"><a href="home.html" class="header-title-link">RPH Interactive Learning Hub
</a></h1>
            </div>

            <div class="header-actions">
                <div class="search-box">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" placeholder="Search" />
                </div>

                <button class="notification-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="notification-badge">2</span>
                </button>
                <button class="sidebar-toggle-right" id="sidebarToggleRight" title="Show more">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="15" y1="3" x2="15" y2="21"></line>
                        <line x1="9" y1="9" x2="9" y2="9.01"></line>
                        <line x1="9" y1="15" x2="9" y2="15.01"></line>
                    </svg>
                </button>
                <button class="logout-btn" title="Logout">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <!-- Left Sidebar Navigation -->
        <aside class="left-sidebar mobile-sidebar" id="leftSidebar">
            <!-- User Profile Section -->
            <div class="user-profile">
                <img src="https://i.pravatar.cc/80?img=20" alt="User avatar" class="profile-avatar" id="profileAvatar" />
                <div class="profile-info">
                    <h4 class="profile-name" id="profileName">Loading...</h4>
                    <p class="profile-email" id="profileEmail">Loading...</p>
                </div>
                <button class="edit-profile-btn" id="editProfileBtn" title="Edit profile">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
            </div>

             <nav class="sidebar-nav">
                <a href="course.html" class="nav-item" data-section="feed">
                    <i data-lucide="radio" class="nav-icon-svg"></i>
                    <span>Feed</span>
                </a>
                <div class="nav-item-dropdown">
                    <div class="nav-item" data-section="topic">
                        <i data-lucide="book-open" class="nav-icon-svg"></i>
                        <span>Topic</span>
                        <i data-lucide="chevron-down" class="dropdown-arrow"></i>
                    </div>
                    <div class="dropdown-menu">
                       <a href="first-mass.html" class="dropdown-item">First Mass</a>
                        <a href="cavite-mutiny.html" class="dropdown-item">Cavite Mutiny</a>

                        <a href="retraction-of-rizal.html" class="dropdown-item">Retraction of Rizal</a>
                        <a href="cry-of-rebellion.html" class="dropdown-item">Cry of Rebellion</a>
                    </div>
                </div>
                <div class="nav-item-dropdown">
                    <div class="nav-item" data-section="activities">
                        <i data-lucide="calendar" class="nav-icon-svg"></i>
                        <span>Learning Hub</span>
                        <i data-lucide="chevron-down" class="dropdown-arrow"></i>
                    </div>
                    <div class="dropdown-menu">
                        <a href="games.html" class="dropdown-item active" data-section="games">
                            <i data-lucide="gamepad-2" style="width: 16px; height: 16px;"></i>
                            Games
                        </a>
                        
                        <a href="interactive-tasks.html" class="dropdown-item" data-section="interactive">
                            <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                            Interactive Tasks
                        </a>

                        <a href="worksheets.html" class="dropdown-item" data-section="worksheets">
                            <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                            Worksheets
                        </a>
                    </div>
                </div>


                <a href="videos.html" class="nav-item" data-section="videos">
                    <i data-lucide="play-circle" class="nav-icon-svg"></i>
                    <span>Videos</span>
                </a>

                <a href="reference.html" class="nav-item" data-section="reference">
                    <i data-lucide="book-open" class="nav-icon-svg"></i>
                    <span>Reference</span>
                </a>
            </nav>

        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="game-container">
                <div class="game-card-main">
                    <div class="game-header">
                        <h1>4 Pics 1 Word</h1>
                        <div class="game-stats">
                            <div class="game-stat">
                                <div class="game-stat-value" id="gameScore">0</div>
                                <div class="game-stat-label">Score</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-value" id="gameLevel">1</div>
                                <div class="game-stat-label">Level</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-value" id="gameTotal">5</div>
                                <div class="game-stat-label">Total</div>
                            </div>
                        </div>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 12.5%"></div>
                    </div>

                    <div class="pictures-grid" id="picturesGrid"></div>

                    <div class="feedback-message" id="feedbackMessage"></div>

                    <div class="input-section">
                        <label class="input-label">What word connects these 4 images?</label>
                        <input 
                            type="text" 
                            id="answerInput" 
                            class="game-input" 
                            placeholder="Type your answer..."
                            autocomplete="off"
                        />
                    </div>

                    <div class="button-group">
                        <button class="game-btn game-btn-submit" onclick="submitAnswer()">Submit</button>
                        <button class="game-btn game-btn-skip" onclick="skipQuestion()">Skip</button>
                    </div>

                    <div style="text-align: center;">
                        <a href="games.html" class="back-button">‚Üê Back to Games</a>
                    </div>
                </div>
            </div>

            <!-- Edit Profile Modal -->
            <div class="modal" id="editProfileModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Profile</h2>
                        <button class="modal-close" id="closeEditModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Profile Picture</label>
                            <img id="avatarPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23e0e0e0' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' font-size='24' fill='%23999' text-anchor='middle' dy='.3em'%3Eüë§%3C/text%3E%3C/svg%3E" alt="Profile preview" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 12px;" />
                            <p style="margin: 0; color: #666; font-size: 14px; background: #f0f0f0; padding: 12px; border-radius: 6px; border-left: 4px solid #5C3422;">
                                üí° <strong>To change your profile picture,</strong> go to the <a href="course.html" style="color: #5C3422; text-decoration: underline;">Feed page</a>
                            </p>
                        </div>
                        <div class="form-group">
                            <label for="editName">Full Name</label>
                            <input type="text" id="editName" placeholder="Your name" />
                        </div>
                        <div class="form-group">
                            <label for="editBio">Bio</label>
                            <textarea id="editBio" placeholder="Tell us about yourself" rows="4"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" id="cancelEditBtn">Cancel</button>
                        <button class="btn-save" id="saveProfileBtn">Save Changes</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Image Modal -->
        <div class="image-modal" id="imageModal">
            <div class="modal-image-content">
                <button class="modal-close-btn" onclick="closeImageModal()">&times;</button>
                <img id="modalImage" src="" alt="Enlarged image" />
            </div>
        </div>

        <!-- Right Sidebar -->
        <aside class="right-sidebar">
            <!-- Game Info Section -->
            <div class="widget">
                <div class="widget-header">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M20 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    <h3>How to Play</h3>
                </div>

                <div class="widget-content">
                    <div class="todo-section">
                        <h4 class="todo-label">Game Rules</h4>
                        <p style="margin: 8px 0; font-size: 13px; color: #7A5B47; line-height: 1.6;">
                            Look at the 4 images and find the word that connects them all. Type your answer and submit. Each correct answer earns you 10 points!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="widget">
                <div class="widget-header">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="12 3 20 7.5 20 16.5 12 21 4 16.5 4 7.5 12 3"></polyline>
                        <line x1="12" y1="12" x2="20" y2="7.5"></line>
                        <line x1="12" y1="12" x2="12" y2="21"></line>
                        <line x1="12" y1="12" x2="4" y2="7.5"></line>
                    </svg>
                    <h3>Leaderboard</h3>
                </div>

                <div class="widget-content">
                    <div id="leaderboardList" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #7A5B47; font-size: 13px; text-align: center;">Loading leaderboard...</p>
                    </div>
                </div>
            </div>

            <!-- Tips Section -->
            <div class="widget">
                <div class="widget-header">
                    <span class="notification-dot">‚óè</span>
                    <h3>Tips</h3>
                </div>

                <div class="widget-content ideas-list">
                    <div class="idea-card">
                        <div class="idea-info">
                            <strong>Think Broadly</strong>
                            <p>Consider different meanings - objects, verbs, famous people, concepts...</p>
                        </div>
                    </div>

                    <div class="idea-card">
                        <div class="idea-info">
                            <strong>Focus on History</strong>
                            <p>These games feature Philippine historical content and personalities...</p>
                        </div>
                    </div>

                    <div class="idea-card">
                        <div class="idea-info">
                            <strong>Use Skip Wisely</strong>
                            <p>Skip a difficult question to move on and see the answer...</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script src="JS/course.js"></script>
    <script>
        // ==================== AUTHENTICATION CHECK ====================
        // Check if user is logged in via Supabase session
        async function checkAuth() {
            try {
                // If userEmail not in localStorage, user is logged out
                if (!localStorage.getItem('userEmail')) {
                    console.log('No user email in localStorage, redirecting to login');
                    window.location.href = 'index.html';
                    return;
                }

                // Wait a bit to ensure Supabase is fully initialized
                await new Promise(resolve => setTimeout(resolve, 100));

                if (!window.supabaseClient) {
                    console.error('Supabase client not initialized');
                    window.location.href = 'index.html';
                    return;
                }

                const { data: { session } } = await window.supabaseClient.auth.getSession();

                if (!session) {
                    console.log('No active session, redirecting to login');
                    window.location.href = 'index.html';
                    return;
                }

                console.log('User authenticated:', session.user.email);
            } catch (error) {
                console.error('Auth check error:', error);
                // If error checking auth, redirect to login to be safe
                window.location.href = 'index.html';
            }
        }

        // 4 Pics 1 Word Game Data
        const gameData = [
            {
                answer: 'cavite mutiny',
                pictures: ['Images/4pics1Word/Item1/pic1.png', 'Images/4pics1Word/Item1/pic2.jpg', 'Images/4pics1Word/Item1/pic3.jpg', 'Images/4pics1Word/Item1/pic4.jpg'],
                hint: 'A failed military uprising in 1872 at Fort San Felipe',
                isImage: true
            },
            {
                answer: 'first mass',
                pictures: ['Images/4pics1Word/Item2/Pic 1.jpg', 'Images/4pics1Word/Item2/Pic 2.jpg', 'Images/4pics1Word/Item2/Pic 3.jpg', 'Images/4pics1Word/Item2/Pic 4.jpg'],
                hint: 'The initial Christian religious ceremony held in the Philippines',
                isImage: true
            },
            {
                answer: 'katipunan',
                pictures: ['Images/4pics1Word/Item3/Pic 1.png', 'Images/4pics1Word/Item3/Pic 2.webp', 'Images/4pics1Word/Item3/Pic 3.jpg', 'Images/4pics1Word/Item3/Pic 4.jpg'],
                hint: 'A secret society that led the Philippine Revolution',
                isImage: true
            },
            {
                answer: 'cry of rebellion',
                pictures: ['Images/4pics1Word/Item 4/pic1.jpg', 'Images/4pics1Word/Item 4/pic2.jpg', 'Images/4pics1Word/Item 4/pic3.jpg', 'Images/4pics1Word/Item 4/pic 4.jpg'],
                hint: 'A revolutionary cry that sparked Filipino uprisings in 1896',
                isImage: true
            },
            {
                answer: 'retraction of rizal',
                pictures: ['Images/4pics1Word/Item5/pic1.webp', 'Images/4pics1Word/Item5/pic2.jpeg', 'Images/4pics1Word/Item5/pic3.jpg', 'Images/4pics1Word/Item5/pic4.jpg'],
                hint: 'The document signed by Jose Rizal renouncing his writings',
                isImage: true
            }
           
        ];

        let currentIndex = 0;
        let score = 0;
        let currentUser = null;

        // Load progress from localStorage on page load
        function loadGameProgress() {
            const savedProgress = localStorage.getItem('gameProgress');
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    currentIndex = progress.currentIndex || 0;
                    score = progress.score || 0;
                    console.log('Loaded game progress - Level:', currentIndex + 1, 'Score:', score);
                } catch (error) {
                    console.log('Could not load saved progress');
                    currentIndex = 0;
                    score = 0;
                }
            }
        }

        // Save progress to localStorage
        function saveGameProgress() {
            const progress = {
                currentIndex: currentIndex,
                score: score,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('gameProgress', JSON.stringify(progress));
        }

        // Load leaderboard after page fully loads
        document.addEventListener('DOMContentLoaded', () => {
            loadGameProgress();
            loadQuestion();
            setTimeout(loadLeaderboard, 500);
        });

        function loadQuestion() {
            if (currentIndex >= gameData.length) {
                showGameOver();
                return;
            }

            const game = gameData[currentIndex];
            const grid = document.getElementById('picturesGrid');
            
            // Check if this question uses images or emojis
            if (game.isImage) {
                grid.innerHTML = game.pictures
                    .map(pic => {
                        return `<div class="picture-item clickable-pic" style="background: linear-gradient(135deg, #f5f3f0 0%, #ede9e4 100%); padding: 0; overflow: hidden;"><img src="${pic}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" alt="game pic" class="game-image" /></div>`;
                    })
                    .join('');
                
                // Add click listeners after DOM update
                setTimeout(() => {
                    document.querySelectorAll('.game-image').forEach(img => {
                        img.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openImageModal(img.src);
                        });
                    });
                }, 50);
            } else {
                grid.innerHTML = game.pictures
                    .map(pic => `<div class="picture-item">${pic}</div>`)
                    .join('');
            }

            document.getElementById('gameScore').textContent = score;
            document.getElementById('gameLevel').textContent = currentIndex + 1;
            document.getElementById('answerInput').value = '';
            document.getElementById('feedbackMessage').classList.remove('show');
            
            const progress = ((currentIndex + 1) / gameData.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
        }

        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.add('active');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }

        // Close modal when clicking outside the image
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeImageModal();
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });

            document.getElementById('answerInput').focus();
        });

        function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim().toLowerCase();
            const correct = gameData[currentIndex].answer;

            if (answer === correct) {
                score += 10;
                showFeedback('‚úì Correct! 10 points!', 'correct');
                setTimeout(() => {
                    currentIndex++;
                    saveGameProgress();
                    loadQuestion();
                }, 1500);
            } else if (answer === '') {
                showFeedback('‚ö† Please enter an answer!', 'incorrect');
            } else {
                showFeedback('‚úó Incorrect. Try again or skip!', 'incorrect');
            }
        }

        function skipQuestion() {
            showFeedback('‚è≠ Skipped! Answer: ' + gameData[currentIndex].answer, 'incorrect');
            setTimeout(() => {
                currentIndex++;
                saveGameProgress();
                loadQuestion();
            }, 1500);
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedbackMessage');
            feedback.textContent = message;
            feedback.className = 'feedback-message show ' + type;
        }

        function showGameOver() {
            const grid = document.getElementById('picturesGrid');
            grid.innerHTML = '';
            
            showFeedback('üéâ Game Complete! Final Score: ' + score + ' points!', 'correct');
            
            document.getElementById('answerInput').disabled = true;
            document.querySelector('.game-btn-submit').disabled = true;
            document.querySelector('.game-btn-skip').disabled = true;
            
            // Save score to leaderboard
            saveGameScore();
            
            setTimeout(() => {
                // Clear progress for new game
                localStorage.removeItem('gameProgress');
                currentIndex = 0;
                score = 0;
                document.getElementById('answerInput').disabled = false;
                document.querySelector('.game-btn-submit').disabled = false;
                document.querySelector('.game-btn-skip').disabled = false;
                loadQuestion();
                loadLeaderboard(); // Refresh leaderboard after new score
            }, 4000);
        }

        // Save game score to Supabase
        async function saveGameScore() {
            try {
                // Check if supabase client is available
                if (typeof window.supabaseClient === 'undefined' || !window.supabaseClient) {
                    console.log('Supabase not initialized - score not saved');
                    return;
                }

                // Get current user
                const session = await getCurrentSession();
                if (!session) {
                    console.log('Not logged in - using guest user');
                    return;
                }

                const user = session.user;
                const userName = user.user_metadata?.full_name || user.email.split('@')[0];
                const userId = user.id;

                // Insert score into leaderboards table
                const response = await window.supabaseClient
                    .from('leaderboards')
                    .insert({
                        user_id: userId,
                        user_name: userName,
                        game_name: '4 Pics 1 Word',
                        score: score,
                        level_reached: currentIndex,
                        played_at: new Date().toISOString()
                    });

                if (response.error) {
                    console.error('Error saving score:', response.error);
                } else {
                    console.log('Score saved successfully!');
                }
            } catch (error) {
                console.error('Failed to save score:', error);
            }
        }

        // Load and display leaderboard
        async function loadLeaderboard() {
            try {
                // Check if supabase client is available
                if (typeof window.supabaseClient === 'undefined' || !window.supabaseClient) {
                    console.log('Supabase not yet initialized, retrying...');
                    setTimeout(loadLeaderboard, 1000);
                    return;
                }

                const response = await window.supabaseClient
                    .from('leaderboards')
                    .select('user_name, score, level_reached, played_at, user_id')
                    .eq('game_name', '4 Pics 1 Word')
                    .order('score', { ascending: false });

                if (response.error) {
                    console.error('Error loading leaderboard:', response.error);
                    document.getElementById('leaderboardList').innerHTML = '<p style="color: #999; font-size: 13px; text-align: center;">Unable to load leaderboard</p>';
                    return;
                }

                let data = response.data;
                if (data.length === 0) {
                    document.getElementById('leaderboardList').innerHTML = '<p style="color: #7A5B47; font-size: 13px; text-align: center;">No scores yet. Be the first!</p>';
                    return;
                }

                // Get only the highest score per user
                const uniqueUsers = {};
                data.forEach(entry => {
                    if (!uniqueUsers[entry.user_id] || entry.score > uniqueUsers[entry.user_id].score) {
                        uniqueUsers[entry.user_id] = entry;
                    }
                });
                
                // Convert back to array and sort by score
                data = Object.values(uniqueUsers).sort((a, b) => b.score - a.score).slice(0, 10);

                let leaderboardHTML = '';
                data.forEach((entry, index) => {
                    const rank = index + 1;
                    let medalDisplay = '';
                    if (rank === 1) {
                        medalDisplay = '<i data-lucide="trophy" style="width: 18px; height: 18px; color: #FFD700; margin-right: 6px;"></i>';
                    } else if (rank === 2) {
                        medalDisplay = '<i data-lucide="medal" style="width: 18px; height: 18px; color: #C0C0C0; margin-right: 6px;"></i>';
                    } else if (rank === 3) {
                        medalDisplay = '<i data-lucide="award" style="width: 18px; height: 18px; color: #CD7F32; margin-right: 6px;"></i>';
                    } else {
                        medalDisplay = `<span style="font-weight: 700; color: #8B7355; margin-right: 6px;">#${rank}</span>`;
                    }

                    leaderboardHTML += `
                        <div style="padding: 10px 0; border-bottom: 1px solid #e8e3dd; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center;">
                                ${medalDisplay}
                                <div>
                                    <div style="font-weight: 600; color: #51513E; font-size: 13px;">${entry.user_name}</div>
                                    <div style="color: #a89b8f; font-size: 11px; margin-top: 2px;">Level ${entry.level_reached || 0}</div>
                                </div>
                            </div>
                            <div style="font-weight: 700; color: #8B7355; font-size: 14px;">${entry.score}</div>
                        </div>
                    `;
                });

                document.getElementById('leaderboardList').innerHTML = leaderboardHTML;
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('leaderboardList').innerHTML = '<p style="color: #999; font-size: 13px; text-align: center;">Error loading leaderboard</p>';
            }
        }

        // Allow Enter key to submit
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        });

        // Initialize Lucide icons
        setTimeout(() => {
            if (window.lucide) {
                lucide.createIcons();
            }
        }, 100);

        // ==================== PROFILE SECTION ====================
        const editProfileBtn = document.getElementById('editProfileBtn');
        const editProfileModal = document.getElementById('editProfileModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const avatarPreview = document.getElementById('avatarPreview');
        const editNameInput = document.getElementById('editName');
        const editBioInput = document.getElementById('editBio');
        const profileNameDisplay = document.querySelector('.profile-name');
        const profileEmailDisplay = document.querySelector('.profile-email');
        const profileAvatar = document.querySelector('.profile-avatar');

        // ==================== LOAD PROFILE FROM localStorage ====================
        const loadProfileFromStorage = () => {
            console.log('üîÑ loadProfileFromStorage called');
            const savedName = localStorage.getItem('profileName');
            const savedBio = localStorage.getItem('profileBio');
            const savedAvatar = localStorage.getItem('profileAvatar');
            const currentUserEmail = profileEmailDisplay.textContent || '';

            localStorage.setItem('currentUserId', currentUserEmail);
            console.log('üì¶ Loaded from localStorage - Name:', savedName, 'Bio:', savedBio, 'Avatar:', savedAvatar ? 'Yes' : 'No');

            if (savedName) {
                console.log('‚úÖ Setting name to:', savedName);
                profileNameDisplay.textContent = savedName;
            }
            if (savedBio) {
                console.log('‚úÖ Setting bio to:', savedBio);
                profileEmailDisplay.textContent = savedBio;
            }
            if (savedAvatar) {
                console.log('‚úÖ Setting avatar');
                profileAvatar.src = savedAvatar;
            }
        };

        // ==================== EDIT PROFILE MODAL MANAGEMENT ====================
        if (editProfileBtn) {
            editProfileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                editProfileModal.classList.add('active');
                editNameInput.value = localStorage.getItem('profileName') || '';
                editBioInput.value = localStorage.getItem('profileBio') || '';
                const savedAvatar = localStorage.getItem('profileAvatar');
                if (savedAvatar) avatarPreview.src = savedAvatar;
            });
        }

        if (closeEditModal) {
            closeEditModal.addEventListener('click', function() {
                editProfileModal.classList.remove('active');
            });
        }

        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', function() {
                editProfileModal.classList.remove('active');
            });
        }

        editProfileModal.addEventListener('click', function(e) {
            if (e.target === editProfileModal) {
                editProfileModal.classList.remove('active');
            }
        });

        // ==================== SAVE PROFILE CHANGES ====================
        if (saveProfileBtn) {
            saveProfileBtn.addEventListener('click', function() {
                alert('To change your profile, please navigate to the Feed page (course.html). Click on your profile picture in the sidebar to edit your profile there.');
                editProfileModal.classList.remove('active');
            });
        }

        loadProfileFromStorage();
        window.addEventListener('load', loadProfileFromStorage);

        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                const savedAvatar = localStorage.getItem('profileAvatar');
                
                if (mutation.type === 'attributes') {
                    const target = mutation.target;
                    const targetId = target.id;
                    const attrName = mutation.attributeName;
                    
                    console.log('üîç Attribute changed - Element:', targetId, 'Attribute:', attrName);
                    console.log('   Current src:', target.src);
                    console.log('   Saved avatar:', savedAvatar ? 'Yes' : 'No');
                    
                    if (savedAvatar && profileAvatar.src !== savedAvatar) {
                        console.log('‚ö†Ô∏è Profile avatar changed, restoring from localStorage');
                        profileAvatar.src = savedAvatar;
                    }
                } else if (mutation.type === 'characterData' || mutation.type === 'childList') {
                    const savedName = localStorage.getItem('profileName');
                    const savedBio = localStorage.getItem('profileBio');
                    
                    if (savedName && profileNameDisplay.textContent !== savedName) {
                        console.log('üìù Restoring name from localStorage');
                        profileNameDisplay.textContent = savedName;
                    }
                    if (savedBio && profileEmailDisplay.textContent !== savedBio) {
                        console.log('üìù Restoring bio from localStorage');
                        profileEmailDisplay.textContent = savedBio;
                    }
                }
            });
        });

        observer.observe(profileNameDisplay, { characterData: true, childList: true, subtree: true });
        observer.observe(profileEmailDisplay, { characterData: true, childList: true, subtree: true });
        observer.observe(profileAvatar, { attributes: true, attributeFilter: ['src'] });

        setInterval(() => {
            const savedAvatar = localStorage.getItem('profileAvatar');
            const savedName = localStorage.getItem('profileName');
            const savedBio = localStorage.getItem('profileBio');
            
            if (savedAvatar && profileAvatar.src !== savedAvatar) {
                console.log('üîÑ Periodic check: Restoring avatar');
                profileAvatar.src = savedAvatar;
            }
            if (savedName && profileNameDisplay.textContent !== savedName) {
                console.log('üîÑ Periodic check: Restoring name');
                profileNameDisplay.textContent = savedName;
            }
            if (savedBio && profileEmailDisplay.textContent !== savedBio) {
                console.log('üîÑ Periodic check: Restoring bio');
                profileEmailDisplay.textContent = savedBio;
            }
        }, 1000);

        // ==================== LOGOUT BUTTON ====================
        const logoutBtn = document.querySelector('.logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    // Clear all local storage
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Sign out from Supabase globally
                    const supabaseClient = await getSupabaseClient();
                    const { error } = await supabaseClient.auth.signOut({ scope: 'global' });
                    if (error) {
                        console.error('Supabase signOut error:', error);
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                } finally {
                    // Force redirect to index after clearing everything
                    window.location.href = 'index.html';
                }
            });
        }

        // ==================== LEFT SIDEBAR TOGGLE ====================
        document.getElementById('toggleSidebar').onclick = function(e) {
            e.stopPropagation();
            const sidebar = document.getElementById('leftSidebar');
            sidebar.classList.toggle('mobile-open');
        };

        // Check authentication on page load
        checkAuth();
    </script>
</body>
</html>
