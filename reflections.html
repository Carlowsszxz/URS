<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflection - Readings in Philippine History</title>
    <link rel="icon" href="Images/favicon.png" type="image/png">
    <link rel="stylesheet" href="Styles/course.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow-x: hidden;
            height: 100%;
        }

        body {
            background: linear-gradient(135deg, #E2D5C2 0%, #F5F1EB 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 20px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5C3422;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .page-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            box-sizing: border-box;
            display: flex;
            align-items: flex-start;
        }

        .reflection-wrapper {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(92, 52, 34, 0.12), 0 10px 40px rgba(92, 52, 34, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            width: 100%;
            display: flex;
            min-height: 650px;
        }

        .reflection-container {
            padding: 40px 36px;
            width: 50%;
            box-sizing: border-box;
            position: relative;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(248, 249, 250, 0.1) 100%);
        }

        .reflection-container::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(180deg, transparent 0%, rgba(226, 213, 194, 0.6) 20%, rgba(226, 213, 194, 0.6) 80%, transparent 100%);
            box-shadow: 0 0 15px rgba(226, 213, 194, 0.3);
        }

        .reflection-display {
            padding: 40px 36px;
            width: 50%;
            box-sizing: border-box;
            position: relative;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(250, 250, 245, 0.05) 100%);
        }

        .reflection-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, rgba(139, 90, 60, 0.3), rgba(184, 134, 11, 0.3), rgba(139, 90, 60, 0.3));
        }

        .display-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #F5F1EB;
        }

        .display-title {
            font-size: 24px;
            font-weight: 700;
            color: #51513E;
            margin: 0 0 8px 0;
            letter-spacing: -0.8px;
        }

        .display-subtitle {
            font-size: 14px;
            color: #7A5B47;
            margin: 0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .reflection-content {
            background: #FAF9F6;
            border: 1px solid #E2D5C2;
            border-radius: 12px;
            padding: 24px;
            height: 300px;
            overflow-y: auto;
            line-height: 1.8;
            color: #5C3422;
            font-size: 16px;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }

        .reflection-content:empty::before {
            content: "Your reflection will appear here once you start writing...";
            color: #9CA3AF;
            font-style: italic;
            position: absolute;
            top: 24px;
            left: 24px;
        }

        .content-meta {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #E2D5C2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #7A5B47;
        }

        .content-stats {
            display: flex;
            gap: 20px;
        }

        .content-date {
            font-style: italic;
        }

        .reflection-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, rgba(92, 52, 34, 0.3), rgba(122, 91, 71, 0.3), rgba(92, 52, 34, 0.3));
        }

        .reflection-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .reflection-title {
            font-size: 28px;
            font-weight: 800;
            color: #51513E;
            margin: 0 0 8px 0;
            letter-spacing: -1.2px;
            line-height: 1.2;
        }

        .reflection-subtitle {
            font-size: 16px;
            color: #7A5B47;
            margin: 0;
            font-weight: 400;
            line-height: 1.5;
            max-width: 600px;
            margin: 0 auto;
        }

        .reflection-field-container {
            position: relative;
            margin-bottom: 16px;
        }

        .reflection-field {
            width: 100%;
            height: 250px;
            padding: 20px;
            border: 2px solid #E2D5C2;
            border-radius: 12px;
            font-size: 16px;
            line-height: 1.7;
            resize: none;
            overflow-y: auto;
            font-family: inherit;
            color: #5C3422;
            background: #FAF9F6;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .reflection-field:focus {
            outline: none;
            border-color: #5C3422;
            box-shadow: 0 0 0 3px rgba(92, 52, 34, 0.1), inset 0 2px 4px rgba(0, 0, 0, 0.05);
            background: #FFFFFF;
        }

        .reflection-field::placeholder {
            color: #9CA3AF;
            font-style: italic;
        }

        .field-hint {
            position: absolute;
            top: -8px;
            left: 16px;
            background: rgba(255, 255, 255, 0.95);
            padding: 0 8px;
            font-size: 12px;
            color: #7A5B47;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 0;
            border-top: 1px solid #E2D5C2;
            border-bottom: 1px solid #E2D5C2;
        }

        .word-count {
            color: #7A5B47;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .word-count i {
            color: #5C3422;
        }

        .character-count {
            color: #7A5B47;
            font-size: 14px;
            font-weight: 500;
        }

        .button-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 0;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #5C3422 0%, #4A2A1A 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(92, 52, 34, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(92, 52, 34, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .topic-card:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #E2D5C2 0%, #D4C5B2 100%);
            color: #5C3422;
            box-shadow: 0 4px 15px rgba(226, 213, 194, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #D4C5B2 0%, #C4B5A2 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(226, 213, 194, 0.4);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #E2D5C2;
            border-top: 4px solid #5C3422;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }

            .page-container {
                flex-direction: column;
                padding: 0 5px;
            }

            .reflection-wrapper {
                flex-direction: column;
                min-height: auto;
                border-radius: 20px;
                box-shadow: 0 12px 40px rgba(92, 52, 34, 0.15);
            }

            .reflection-container {
                width: 100%;
                padding: 24px 20px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(248, 249, 250, 0.1) 100%);
            }

            .reflection-container::after {
                display: none;
            }

            .reflection-container::before {
                content: '';
                position: absolute;
                bottom: 0;
                left: 20px;
                right: 20px;
                height: 1px;
                background: linear-gradient(90deg, transparent 0%, rgba(226, 213, 194, 0.4) 50%, transparent 100%);
            }

            .reflection-display {
                width: 100%;
                padding: 24px 20px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(250, 250, 245, 0.05) 100%);
            }

            .reflection-title {
                font-size: 22px;
                margin-bottom: 6px;
            }

            .display-title {
                font-size: 20px;
            }

            .reflection-subtitle {
                font-size: 14px;
                line-height: 1.4;
            }

            .reflection-field {
                height: 200px;
                padding: 16px 12px;
                font-size: 16px;
                border-radius: 10px;
            }

            .reflection-content {
                padding: 16px;
                font-size: 15px;
                height: 200px;
            }

            .button-container {
                gap: 10px;
                margin-top: 8px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 14px;
                font-weight: 600;
                min-height: 44px; /* iOS touch target */
                border-radius: 8px;
            }

            .stats-container {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
                padding: 8px 0;
                margin-bottom: 12px;
            }

            .word-count, .character-count {
                text-align: center;
                padding: 8px 12px;
                background: rgba(255, 255, 255, 0.5);
                border-radius: 6px;
                font-size: 13px;
            }

            .content-meta {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .content-stats {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px 8px;
            }

            .page-container {
                padding: 0 2px;
            }

            .reflection-container {
                padding: 20px 16px;
                border-radius: 12px;
                margin: 0;
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(248, 249, 250, 0.1) 100%);
            }

            .reflection-title {
                font-size: 18px;
                letter-spacing: -0.8px;
            }

            .reflection-subtitle {
                font-size: 13px;
            }

            .reflection-field {
                height: 180px;
                padding: 14px 10px;
                font-size: 16px;
                border-radius: 8px;
            }

            .field-hint {
                font-size: 11px;
                top: -6px;
                left: 12px;
                padding: 0 6px;
            }

            .button-container {
                gap: 8px;
                flex-direction: column;
                margin-top: 12px;
            }

            .btn {
                width: 100%;
                padding: 14px 12px;
                font-size: 15px;
                min-height: 48px; /* Better touch target */
                border-radius: 8px;
            }

            .stats-container {
                gap: 6px;
                padding: 6px 0;
                margin-bottom: 8px;
            }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .reflection-field:focus {
                outline: none;
                border-color: #5C3422;
                box-shadow: 0 0 0 2px rgba(92, 52, 34, 0.2);
            }

            .btn:focus {
                outline: 2px solid #5C3422;
                outline-offset: 2px;
            }

            /* Improve readability on small screens */
            .reflection-field {
                -webkit-appearance: none;
                appearance: none;
            }

        /* Very small screens */
        @media (max-width: 360px) {
            body {
                padding: 10px 6px;
            }

            .page-container {
                padding: 0 1px;
            }

            .reflection-container {
                padding: 16px 12px;
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(248, 249, 250, 0.1) 100%);
            }

            .reflection-title {
                font-size: 16px;
            }

            .reflection-subtitle {
                font-size: 12px;
            }

            .reflection-field {
                height: 160px;
                padding: 12px 8px;
                font-size: 15px;
            }

            .btn {
                padding: 12px 10px;
                font-size: 14px;
                min-height: 44px;
            }
        }

        /* Topic Selector Styles */
        .topic-selector {
            margin-top: 32px;
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .topic-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #E2D5C2;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .topic-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(92, 52, 34, 0.05), transparent);
            transition: left 0.5s;
        }

        .topic-card:hover {
            border-color: #5C3422;
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(92, 52, 34, 0.15);
        }

        .topic-card:hover::before {
            left: 100%;
        }

        .topic-title {
            font-size: 18px;
            font-weight: 700;
            color: #51513E;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .topic-description {
            font-size: 14px;
            color: #7A5B47;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .topic-meta {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .topic-meta span {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .difficulty {
            background: #E2D5C2;
            color: #5C3422;
        }

        .type {
            background: #5C3422;
            color: white;
        }

        @media (max-width: 768px) {
            .topics-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .topic-card {
                padding: 20px 16px;
                border-radius: 12px;
                min-height: 120px;
            }

            .topic-title {
                font-size: 16px;
                margin-bottom: 8px;
            }

            .topic-description {
                font-size: 13px;
                line-height: 1.4;
                margin-bottom: 12px;
            }

            .topic-meta {
                gap: 8px;
            }

            .topic-meta span {
                font-size: 11px;
                padding: 3px 6px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .topics-grid {
                gap: 12px;
            }

            .topic-card {
                padding: 16px 12px;
                min-height: 100px;
                border-radius: 10px;
            }

            .topic-title {
                font-size: 15px;
                margin-bottom: 6px;
            }

            .topic-description {
                font-size: 12px;
                margin-bottom: 10px;
            }

            .topic-meta span {
                font-size: 10px;
                padding: 2px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="reflection-wrapper">
            <div class="reflection-container">
                <div class="reflection-header">
                    <h1 class="reflection-title" id="reflectionTitle">Reflection</h1>
                    <p class="reflection-subtitle" id="reflectionDescription">Take a moment to reflect on what you've learned. Choose a topic from the worksheets to get started.</p>
                </div>

                <div class="reflection-field-container">
                    <div class="field-hint">Write Your Reflection</div>
                    <textarea class="reflection-field" id="reflectionText" placeholder="Share your thoughts, insights, and personal connections to the topic. Write freely about what resonates with you..."></textarea>
                </div>

                <div class="stats-container">
                    <div class="word-count" id="wordCount">
                        <i class="fas fa-file-alt"></i>
                        Word count: 0
                    </div>
                    <div class="character-count" id="characterCount">
                        Characters: 0
                    </div>
                </div>

                <div class="button-container">
                    <a href="worksheets.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Back to Worksheets
                    </a>
                    <button class="btn btn-primary" onclick="saveReflection()" id="saveBtn">
                        <i class="fas fa-save"></i>
                        Save Reflection
                    </button>
                    <button class="btn btn-secondary" onclick="clearReflection()" id="clearBtn">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>
                </div>
            </div>

            <div class="reflection-display">
                <div class="display-header">
                    <h2 class="display-title">Your Reflection</h2>
                    <p class="display-subtitle">Professional Display</p>
                </div>

                <div class="reflection-content" id="reflectionContent"></div>

                <div class="content-meta">
                    <div class="content-stats">
                        <span id="displayWordCount">Words: 0</span>
                        <span id="displayCharCount">Characters: 0</span>
                    </div>
                    <div class="content-date" id="lastSaved">Not saved yet</div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Include required scripts -->
    <script src="JS/supabase-config.js"></script>
    <script src="JS/supabase-client.js"></script>
    <script src="JS/db-helpers.js"></script>

    <script>
        // Reflections data (fallback for when database is not available)
        const reflections = [
            {
                id: 1,
                title: "The Dawn of Filipino Christianity: Reflecting on the First Mass",
                description: "Explore the profound impact of the first Catholic Mass celebrated in the Philippines on Easter Sunday, 1521. How did this historic event shape Filipino identity, culture, and the spiritual foundation of our nation? Consider the blending of Spanish Catholicism with indigenous traditions and its lasting influence on Filipino society.",
                topic: "mass",
                type: "Deep Reflection",
                difficulty: "Intermediate",
                questions: 1,
                estimatedTime: "15-20 mins"
            },
            {
                id: 2,
                title: "Rizal Retraction",
                description: "If you will be Rizal, would you retract or not? Make a journal entry about that.",
                topic: "rizal",
                type: "Personal Reflection",
                difficulty: "Intermediate",
                questions: 1,
                estimatedTime: "15-20 mins"
            },
            {
                id: 3,
                title: "Cavite Mutiny",
                description: "Reflect on the Cavite Mutiny and its impact on Philippine history. What were the causes and consequences of this significant event?",
                topic: "cavite",
                type: "Historical Analysis",
                difficulty: "Intermediate",
                questions: 1,
                estimatedTime: "15-20 mins"
            },
            {
                id: 4,
                title: "Cry of Rebellion",
                description: "Reflect on the Cry of Rebellion (1896) and its significance in Philippine history. What factors led to this pivotal moment?",
                topic: "rebellion",
                type: "Historical Reflection",
                difficulty: "Intermediate",
                questions: 1,
                estimatedTime: "15-20 mins"
            }
        ];

        // DOM elements
        const textarea = document.getElementById('reflectionText');
        const wordCountDisplay = document.getElementById('wordCount');
        const characterCountDisplay = document.getElementById('characterCount');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');

        // Load reflection based on URL parameter
        async function loadReflection() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = parseInt(urlParams.get('id'));

            console.log('Loading reflection with ID:', id);

            if (!id) {
                console.log('No ID provided, loading available reflections');
                await loadAvailableReflections();
                return;
            }

            try {
                // Try to load from database first
                if (window.DB && id) {
                    console.log('Trying to load from database...');
                    const result = await window.DB.getReflectionPrompt(id);
                    if (result.success && result.data) {
                        console.log('Loaded from database:', result.data);
                        document.getElementById('reflectionTitle').textContent = result.data.title;
                        document.getElementById('reflectionDescription').textContent = result.data.description;

                        // Load user's saved reflection
                        await loadUserReflection(id);
                        return;
                    } else {
                        console.warn('Database query failed:', result);
                    }
                }
            } catch (error) {
                console.warn('Database not available, using fallback data:', error);
            }

            // Fallback to local data
            if (id && reflections.find(r => r.id === id)) {
                console.log('Using fallback data for ID:', id);
                const reflection = reflections.find(r => r.id === id);
                document.getElementById('reflectionTitle').textContent = reflection.title;
                document.getElementById('reflectionDescription').textContent = reflection.description;
            } else {
                console.warn('No reflection found for ID:', id);
                document.getElementById('reflectionTitle').textContent = 'Reflection';
                document.getElementById('reflectionDescription').textContent = 'Unable to load the requested reflection topic. Please try selecting a topic from the worksheets.';
            }

            // No localStorage fallback - only database storage
        }

        // Load available reflections when no specific ID is provided
        async function loadAvailableReflections() {
            try {
                // Try to load from database first
                if (window.DB) {
                    console.log('Loading available reflections from database...');
                    const result = await window.DB.getReflectionPrompts();
                    if (result.success && result.data && result.data.length > 0) {
                        console.log('Found reflections in database:', result.data.length);
                        showReflectionSelector(result.data);
                        return;
                    }
                }
            } catch (error) {
                console.warn('Database not available for reflections list:', error);
            }

            // Fallback to local data
            console.log('Using fallback reflections data');
            showReflectionSelector(reflections);
        }

        // Show a selector for available reflections
        function showReflectionSelector(availableReflections) {
            document.getElementById('reflectionTitle').textContent = 'Choose a Reflection Topic';
            document.getElementById('reflectionDescription').textContent = 'Select a topic below to begin reflecting on what you\'ve learned.';

            // Create topic selector
            const selectorHTML = `
                <div class="topic-selector">
                    <div class="topics-grid">
                        ${availableReflections.map(reflection => `
                            <div class="topic-card" onclick="selectReflection(${reflection.id})">
                                <div class="topic-title">${reflection.title}</div>
                                <div class="topic-description">${reflection.description}</div>
                                <div class="topic-meta">
                                    <span class="difficulty">${reflection.difficulty || 'Beginner'}</span>
                                    <span class="type">${reflection.type || 'Writing Reflection'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Insert after the description
            const description = document.getElementById('reflectionDescription');
            description.insertAdjacentHTML('afterend', selectorHTML);

            // Hide the textarea and stats until a topic is selected
            document.querySelector('.reflection-field-container').style.display = 'none';
            document.querySelector('.stats-container').style.display = 'none';
            document.querySelector('.button-container').style.display = 'none';
        }

        // Handle topic selection
        function selectReflection(id) {
            // Update URL without page reload
            const url = new URL(window.location);
            url.searchParams.set('id', id);
            window.history.pushState({}, '', url);

            // Remove selector and show reflection interface
            const selector = document.querySelector('.topic-selector');
            if (selector) selector.remove();

            // Show the textarea and controls
            document.querySelector('.reflection-field-container').style.display = 'block';
            document.querySelector('.stats-container').style.display = 'flex';
            document.querySelector('.button-container').style.display = 'flex';

            // Load the selected reflection
            loadReflection();
        }

        // Load user's reflection from database
        async function loadUserReflection(reflectionId) {
            try {
                if (!window.DB) return;

                // Get current user
                const supabaseClient = await getSupabaseClient();
                const { data: session } = await supabaseClient.auth.getSession();

                if (session?.session?.user) {
                    const result = await window.DB.getUserReflection(session.session.user.id, reflectionId);
                    if (result.success && result.data) {
                        // Show content in the professional display area
                        updateReflectionDisplay(result.data.content);

                        // Update last saved time
                        const savedDate = new Date(result.data.updated_at || result.data.created_at);
                        document.getElementById('lastSaved').textContent = `Last saved: ${savedDate.toLocaleDateString()} ${savedDate.toLocaleTimeString()}`;

                        // Update counts based on loaded content
                        updateCountsFromContent(result.data.content);
                    }
                }
            } catch (error) {
                console.warn('Error loading user reflection from database:', error);
            }
        }

        // Save reflection
        async function saveReflection() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id') || 'default';
            const text = textarea.value.trim();

            if (!text) {
                showNotification('Please write something before saving.', 'warning');
                return;
            }

            // Show loading
            setLoading(true);

            try {
                // Check if DB is available
                if (!window.DB) {
                    showNotification('Database connection not available. Please try again later.', 'error');
                    return;
                }

                // Get current user
                const supabaseClient = await getSupabaseClient();
                const { data: session } = await supabaseClient.auth.getSession();

                if (!session?.session?.user) {
                    showNotification('Please log in to save your reflection.', 'warning');
                    return;
                }

                // Save to database
                const result = await window.DB.saveUserReflection(session.session.user.id, parseInt(id), text);
                if (result.success) {
                    showNotification('Reflection saved successfully!', 'success');
                    // Update last saved time
                    const now = new Date();
                    document.getElementById('lastSaved').textContent = `Last saved: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                } else {
                    showNotification('Failed to save reflection. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error saving reflection:', error);
                showNotification('An error occurred while saving. Please try again.', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Clear reflection
        async function clearReflection() {
            if (!confirm('Are you sure you want to clear your reflection? This cannot be undone.')) {
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            setLoading(true);

            try {
                // Check if DB is available
                if (!window.DB || !id) {
                    showNotification('Database connection not available.', 'error');
                    return;
                }

                // Get current user
                const supabaseClient = await getSupabaseClient();
                const { data: session } = await supabaseClient.auth.getSession();

                if (!session?.session?.user) {
                    showNotification('Please log in to clear your reflection.', 'warning');
                    return;
                }

                // Delete from database
                const result = await window.DB.deleteUserReflection(session.session.user.id, parseInt(id));
                if (result.success) {
                    // Keep textarea empty, only clear the display area
                    updateReflectionDisplay('');
                    updateCountsFromContent('');
                    document.getElementById('lastSaved').textContent = 'Not saved yet';
                    showNotification('Reflection cleared successfully!', 'success');
                } else {
                    showNotification('Failed to clear reflection. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error clearing reflection:', error);
                showNotification('An error occurred while clearing. Please try again.', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Update word and character counts
        function updateCounts() {
            const text = textarea.value;
            const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const characterCount = text.length;

            wordCountDisplay.innerHTML = `<i class="fas fa-file-alt"></i> Word count: ${wordCount}`;
            characterCountDisplay.textContent = `Characters: ${characterCount}`;

            // Update display stats
            document.getElementById('displayWordCount').textContent = `Words: ${wordCount}`;
            document.getElementById('displayCharCount').textContent = `Characters: ${characterCount}`;

            // Update display content in real-time
            updateReflectionDisplay(text);
        }

        // Update counts from loaded content (for when textarea is empty but display has content)
        function updateCountsFromContent(content) {
            const wordCount = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;
            const characterCount = content.length;

            wordCountDisplay.innerHTML = `<i class="fas fa-file-alt"></i> Word count: ${wordCount}`;
            characterCountDisplay.textContent = `Characters: ${characterCount}`;

            // Update display stats
            document.getElementById('displayWordCount').textContent = `Words: ${wordCount}`;
            document.getElementById('displayCharCount').textContent = `Characters: ${characterCount}`;
        }

        // Update the professional reflection display
        function updateReflectionDisplay(content) {
            const displayElement = document.getElementById('reflectionContent');
            if (content.trim() === '') {
                displayElement.textContent = '';
            } else {
                displayElement.textContent = content;
            }
        }

        // Show loading overlay
        function setLoading(loading) {
            loadingOverlay.style.display = loading ? 'flex' : 'none';
            saveBtn.disabled = loading;
            clearBtn.disabled = loading;
            textarea.disabled = loading;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas ${getIconForType(type)}"></i>
                <span>${message}</span>
            `;

            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${getColorForType(type)};
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1001;
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 500;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 400px;
            `;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        function getIconForType(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        function getColorForType(type) {
            switch (type) {
                case 'success': return '#10B981';
                case 'error': return '#EF4444';
                case 'warning': return '#F59E0B';
                default: return '#3B82F6';
            }
        }

        // ==================== AUTHENTICATION CHECK ====================
        // Check if user is logged in via Supabase session
        async function checkAuth() {
            try {
                // If userEmail not in localStorage, user is logged out
                if (!localStorage.getItem('userEmail')) {
                    console.log('No user email in localStorage, redirecting to login');
                    window.location.href = 'index.html';
                    return;
                }

                // Wait a bit to ensure Supabase is fully initialized
                await new Promise(resolve => setTimeout(resolve, 100));

                if (!window.supabaseClient) {
                    console.error('Supabase client not initialized');
                    window.location.href = 'index.html';
                    return;
                }

                const { data: { session } } = await window.supabaseClient.auth.getSession();

                if (!session) {
                    console.log('No active session, redirecting to login');
                    window.location.href = 'index.html';
                    return;
                }

                console.log('User authenticated:', session.user.email);
            } catch (error) {
                console.error('Auth check error:', error);
                // If error checking auth, redirect to login to be safe
                window.location.href = 'index.html';
            }
        }

        // Helper function to get Supabase client
        async function getSupabaseClient() {
            let attempts = 0;
            while (attempts < 50) {
                if (window.supabaseClient) {
                    return window.supabaseClient;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            throw new Error('Supabase client not initialized');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadReflection();

            // Add input event listener for counts
            textarea.addEventListener('input', updateCounts);

            // Initial counts
            updateCounts();

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 's') {
                        e.preventDefault();
                        saveReflection();
                    } else if (e.key === 'Enter' && e.shiftKey) {
                        e.preventDefault();
                        clearReflection();
                    }
                }
            });
        });

        // Check authentication on page load
        checkAuth();
    </script>
